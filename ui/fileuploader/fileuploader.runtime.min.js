TW.Runtime.Widgets.fileuploader=function(){function n(a){l=m=k=0;var f=d.getProperty("maximumFileSize"),c=d.getProperty("allowedFileTypes").toLowerCase();g=[];for(var b=0;b<a.length;b++){var e=0>=f||a[b].size/1048576<=f,h=0===c.length||-1!==c.indexOf("."+a[b].name.split(".").pop().toLowerCase());e&&h&&g.push(a[b])}if(g.length){d.jqElement.triggerHandler("UploadStarted");a={files:[]};f={files:[]};c=d.getProperty("path");for(b=0;b<g.length;b++)l+=g[b].size,e=c+(c.lastIndexOf("/")===c.length-1?"":"/")+
g[b].name,d.setProperty("fileName",g[b].name),d.setProperty("fullPath",e),a.files.push(g[b].name),f.files.push(e);d.setProperty("fileNames",JSON.stringify(a));d.setProperty("fullPaths",JSON.stringify(f));p()}else d.jqElement.triggerHandler("FilesNotCompatible")}function p(){var a=d.getProperty("debugMode"),f=new FormData;f.append("upload-repository-"+e,d.getProperty("repositoryName"));f.append("upload-path-"+e,d.getProperty("path"));f.append("upload-files-"+e,g[k]);var c=new XMLHttpRequest;c.open("POST",
"/Thingworx/FileRepositoryUploader",!0);c.setRequestHeader("X-XSRF-TOKEN","TWX-XSRF-TOKEN-VALUE");c.upload.addEventListener("progress",function(b){b=Math.floor(100*(m+b.loaded)/l);a&&console.log("FileUploader - progress - percentComplete = "+b);d.setProperty("progress",b);d.jqElement.triggerHandler("UploadProgress")},!1);c.onreadystatechange=function(){4===this.readyState&&(200===this.status?(m+=g[k].size,k++,k===g.length?(a&&console.log("FileUploader - success"),d.jqElement.triggerHandler("UploadComplete")):
p()):(a&&console.log("FileUploader - error"),d.jqElement.triggerHandler("UploadFailed")))};c.send(f)}function h(a,f,c,b,e){var g=d.getProperty("debugMode");if(a.dataTransfer.items){var h=[];for(var k=0;k<a.dataTransfer.items.length;k++)"file"===a.dataTransfer.items[k].kind&&h.push(a.dataTransfer.items[k].getAsFile())}else h=a.dataTransfer.files;g&&console.log("FileUploader - "+f+" - files.length = "+h.length);h&&h.length&&(b&&(a.preventDefault(),a.dataTransfer.dropEffect="copy"),c&&d.jqElement.triggerHandler(c),
e&&n(h))}var d=this,e=(new Date).getTime()+"_"+Math.floor(1E3*Math.random()),k,m,l,g,q=TW.Runtime.convertLocalizableString("[[FileUploaderWidget.fileuploader.dragorclick]]","Drag your image here or click in this area");this.runtimeProperties=function(){return{supportsAutoResize:!0,needsDataLoadingAndError:!1}};this.renderHtml=function(){return'<div class="widget-content widget-fileuploader widget-fileuploader-'+e+'">  <div class="widget-fileuploader-div widget-fileuploader-div-'+e+'">    <span class="widget-fileuploader-span widget-fileuploader-span-'+
e+'">'+q+'</span>  </div>  <input id="upload-files-'+e+'" name="upload-files-'+e+'" type="file" style="display:none;"></div>'};this.afterRender=function(){var a=document.getElementById("upload-files-"+e);a.onchange=function(b){n(a.files);a.value=""};var f=0,c=document.getElementsByClassName("widget-fileuploader-div-"+e)[0];c.ondragenter=function(a){f++;h(a,"ondragenter","OnDragEnter",!1,!1)};c.ondragover=function(a){h(a,"ondragover","",!0,!1)};c.ondragleave=function(a){f--;0===f&&h(a,"ondragleave",
"OnDragLeave",!1,!1)};c.ondrop=function(a){f=0;h(a,"ondrop","OnDrop",!0,!0)};c.onclick=function(b){a.setAttribute("accept",d.getProperty("allowedFileTypes"));d.getProperty("allowMultipleFiles")&&a.setAttribute("multiple","multiple");b=document.createEvent("MouseEvents");b.initEvent("click",!1,!1);a.dispatchEvent(b)}};this.serviceInvoked=function(a){"Open"===a&&(a=document.createEvent("MouseEvents"),a.initEvent("click",!1,!1),document.getElementById("upload-files-"+e).dispatchEvent(a))};this.updateProperty=
function(a){-1!=="debugMode repositoryName path allowMultipleFiles allowedFileTypes maximumFileSize".split(" ").indexOf(a.TargetProperty)&&this.setProperty(a.TargetProperty,a.RawSinglePropertyValue)};this.beforeDestroy=function(){}};