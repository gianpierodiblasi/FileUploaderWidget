TW.Runtime.Widgets.fileuploader=function(){function q(a){m=n=k=0;t(a);if(g.length){c.jqElement.triggerHandler("UploadStarted");a={files:[]};for(var f={files:[]},d=c.getProperty("path"),b=0;b<g.length;b++){m+=g[b].size;var e=d+(d.lastIndexOf("/")===d.length-1?"":"/")+g[b].name;c.setProperty("fileName",g[b].name);c.setProperty("fullPath",e);a.files.push(g[b].name);f.files.push(e)}c.setProperty("fileNames",JSON.stringify(a));c.setProperty("fullPaths",JSON.stringify(f));r()}else c.jqElement.triggerHandler("FilesNotCompatible")}
function t(a){var f=c.getProperty("maximumFileSize"),d=c.getProperty("allowedFileTypes").split(",").filter(function(a){return!!a});g=[];for(var b=0;b<a.length;b++){var e=0>=f||a[b].size/1048576<=f,p=0===d.length||-1!==d.indexOf("."+a[b].name.split(".").pop());e&&p&&g.push(a[b])}}function r(){var a=c.getProperty("debugMode"),f=new FormData;f.append("upload-repository-"+h,c.getProperty("repositoryName"));f.append("upload-path-"+h,c.getProperty("path"));f.append("upload-files-"+h,g[k]);var d=new XMLHttpRequest;
d.open("POST","/Thingworx/FileRepositoryUploader",!0);d.setRequestHeader("X-XSRF-TOKEN","TWX-XSRF-TOKEN-VALUE");d.upload.addEventListener("progress",function(b){b=Math.floor(100*(n+b.loaded)/m);a&&console.log("FileUploader - progress - percentComplete = "+b);c.setProperty("progress",b);c.jqElement.triggerHandler("UploadProgress")},!1);d.onreadystatechange=function(){4===this.readyState&&(200===this.status?(n+=g[k].size,k++,k===g.length?(a&&console.log("FileUploader - success"),c.jqElement.triggerHandler("UploadComplete")):
r()):(a&&console.log("FileUploader - error"),c.jqElement.triggerHandler("UploadFailed")))};d.send(f)}function l(a,f,d,b,g){var p=c.getProperty("debugMode");if(a.dataTransfer.items){var e=[];for(var h=0;h<a.dataTransfer.items.length;h++)"file"===a.dataTransfer.items[h].kind&&e.push(a.dataTransfer.items[h].getAsFile())}else e=a.dataTransfer.files;p&&console.log("FileUploader - "+f+" - files.length = "+e.length);e&&e.length&&(b&&(a.preventDefault(),a.dataTransfer.dropEffect="copy"),d&&c.jqElement.triggerHandler(d),
g&&q(e))}var c=this,h=(new Date).getTime()+"_"+Math.floor(1E3*Math.random()),k,n,m,g;this.runtimeProperties=function(){return{needsDataLoadingAndError:!1}};this.renderHtml=function(){return'<div class="widget-content widget-fileuploader" style="display:none;">  <input id="upload-files-'+h+'" name="upload-files-'+h+'" type="file"></div>'};this.afterRender=function(){var a=c.getProperty("widgetType"),f=c.getProperty("fileUploadCustomClass"),d=document.getElementById("upload-files-"+h);d.onchange=function(a){q(d.files);
d.value=""};switch(a){case "component":var b=document.getElementsByClassName(f)[0];break;case "container":var e=0;b=this.jqElement.closest("."+f).get(0);b.ondragenter=function(a){e++;l(a,"ondragenter","OnDragEnter",!1,!1)};b.ondragover=function(a){l(a,"ondragover","",!0,!1)};b.ondragleave=function(a){e--;0===e&&l(a,"ondragleave","OnDragLeave",!1,!1)};b.ondrop=function(a){e=0;l(a,"ondrop","OnDrop",!0,!0)}}b.onclick=function(a){d.setAttribute("accept",c.getProperty("allowedFileTypes"));c.getProperty("allowMultipleFiles")&&
d.setAttribute("multiple","multiple");a=document.createEvent("MouseEvents");a.initEvent("click",!1,!1);d.dispatchEvent(a)}};this.serviceInvoked=function(a){};this.updateProperty=function(a){-1!=="debugMode widgetType fileUploadCustomClass repositoryName path allowMultipleFiles allowedFileTypes maximumFileSize".split(" ").indexOf(a.TargetProperty)&&this.setProperty(a.TargetProperty,a.RawSinglePropertyValue)};this.beforeDestroy=function(){}};